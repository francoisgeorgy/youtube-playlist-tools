<html>
<head>
    <title>Content of playlist</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="auth.js"></script>
    <script src="secrets.js"></script>
    </head>
<body>
    <button id="execute-request-button">Authorize</button>
    <div>
        <a href="playlists-list.html">back to playlists</a>
    </div>
    <h3 id="playlist-title"></h3>
    <div id="playlist-description"></div>
    <pre id="data"></pre>
    <script>

        var urlParams = new URLSearchParams(window.location.search);
        var playlistID = urlParams.get('id')
        // console.log(playlistID);

        var playlistItems = [];

        function clearData() {
            $('#data').html('');
        }

        function print(s) {
            $('#data').append(`${s}\n`);
        }

        function printList(a) {
            for(item of a) {
                print(`<a href="https://www.youtube.com/watch?v=${item.videoId}" target="v" title="${item.description}">${item.title}</a>`);
            }
        }

        function displayPlaylistInfo(infos) {
            console.log("displayPlaylistInfo");
            $("#playlist-title").text(infos.items[0].snippet.title);
            $("#playlist-description").text(infos.items[0].snippet.description);
        }

        function retrievePlaylistInfo(id) {
            console.log("playlistInfoRequest");
            let request = buildApiRequest('GET', '/youtube/v3/playlists', {'id': id, 'part': 'snippet,contentDetails'});
            executeRequest(request, displayPlaylistInfo);
        }

        function displayPlaylistContent(data) {

            console.log("displayPlaylistContent");

            if (!data) return;

            for(item of data.items) {
                // console.log(item);
                playlistItems.push({
                    id: item.id,
                    title: item.snippet.title,
                    description: item.snippet.description,
                    videoId: item.snippet.resourceId.videoId
                });
            }

            playlistItems.sort(
                function(a, b) {
                    return (a.title.toLowerCase() > b.title.toLowerCase()) ? 1 : ((b.title.toLowerCase() > a.title.toLowerCase()) ? -1 : 0);
                }
            );

            clearData();
            print(`${playlistItems.length} videos`);
            printList(playlistItems);

            if (data.nextPageToken) {
                console.log('get next page', data.nextPageToken);
                retrievePlaylistContent(data.nextPageToken);
            }
        }

        function retrievePlaylistContent(nextPageToken) {
            console.log("retrievePlaylistContent", nextPageToken);
            let request = buildApiRequest(
                'GET',
                '/youtube/v3/playlistItems',
                {
                    'maxResults': '50',
                    'part': 'snippet,contentDetails',
                    'playlistId': playlistID,
                    'pageToken': nextPageToken
                });
            executeRequest(request, displayPlaylistContent);
        }

        // method called by auth.js after authentication
        function main() {
            console.log("main");
            retrievePlaylistInfo(playlistID);
            retrievePlaylistContent();
        }

    </script>
    <script src="https://apis.google.com/js/api.js?onload=handleClientLoad"></script>
</body>
</html>
